<script lang="ts">
	import { Dropzone } from 'flowbite-svelte';
	import { afterUpdate, createEventDispatcher } from 'svelte';
	import { Photo, XMark } from 'svelte-heros-v2';
	import { ImgSourceEnum } from '../../models/imgSourceEnum';
	import { onMount } from 'svelte';
	import type { ImagesModel } from '../../models/imagesModel';

	export let data: { images?: ImagesModel[] } = {};
	let images: ImagesModel[] = data.images ?? [];

	afterUpdate(() => {
		if (images.length === 0) {
			images = data.images ?? [];
		}
	});
	const dispatch = createEventDispatcher();
	let imageFiles: File[] = [];

	function addImage(e: Event) {
		console.log('//////e', e);
		const fileInput = e.target as HTMLInputElement;
		for (let file of fileInput!.files!) {
			imageFiles = [...imageFiles, file];

			const reader = new FileReader();
			reader.onloadend = () => {
				let imgSource = ImgSourceEnum.local;
				let fileName = file.name; // Store the name of the uploaded file
				if (file.type === 'application/pdf') {
					imgSource = ImgSourceEnum.pdf;
				}
				images = [
					...images,
					{
						id: images.length,
						imgurl: reader.result as string,
						imgSource: imgSource,
						fileName: fileName
					}
				];
			};
			reader.readAsDataURL(file);
		}
	}

	function deleteImage(index: number) {
		const updatedImages = [...images];
		updatedImages.splice(index, 1);
		imageFiles.splice(index, 1);
		images = updatedImages;
		console.log('//////i', images);
	}

	$: {
		if (images.length > 0) {
			runEvent();
		}
	}

	function runEvent() {
		dispatch('imageChanges', images);
		dispatch('imageFilesChanges', imageFiles);
	}
</script>

<div class="w-full h-80 bg-[#e4e4e4] rounded-lg p-5 flex flex-wrap">
	<Dropzone
		multiple
		id="dropzone"
		type="file"
		accept=".jpg, .jpeg, .png .svg .pdf"
		on:change={addImage}>upload</Dropzone
	>

	{#each images as image, index}
		<div class="h-24 w-24 bg-[#f1f3f4] mx-2 rounded-lg relative">
			<button
				class="bg-red-700 absolute -top-2 -right-2 rounded-full border-2 cursor-pointer"
				on:click={(event) => {
					event.stopPropagation();
					deleteImage(index);
				}}
			>
				<XMark class="text-xs h-5 w-5 text-white" />
			</button>
			{#if image.imgSource === ImgSourceEnum.pdf}
				<div class="rounded-lg object-cover h-full w-full flex items-center justify-center">
					<svg
						width="24"
						height="24"
						viewBox="0 0 64 64"
						fill="none"
						xmlns="http://www.w3.org/2000/svg"
					>
						<path
							d="M48.1998 4.14404L59.3278 15.744V59.856H17.7578V60H59.4698V15.89L48.1998 4.14404Z"
							fill="#909090"
						/>
						<path d="M48.0622 4H17.6162V59.856H59.3282V15.746L48.0622 4Z" fill="#F4F4F4" />
						<path d="M17.3103 7H4.53027V20.654H44.7303V7H17.3103Z" fill="#7A7B7C" />
						<path d="M44.944 20.4218H4.79004V6.75781H44.944V20.4218Z" fill="#DD2025" />
						<path
							d="M18.1042 9.06787H18.0442H17.6302H15.4902V18.6679H17.5462V15.4299L18.0002 15.4559C18.4414 15.4483 18.8784 15.3693 19.2942 15.2219C19.6588 15.0965 19.9943 14.8985 20.2802 14.6399C20.5712 14.3935 20.8007 14.0826 20.9502 13.7319C21.1508 13.1489 21.2225 12.5293 21.1602 11.9159C21.1477 11.4777 21.0709 11.0437 20.9322 10.6279C20.806 10.3277 20.6186 10.0571 20.3821 9.83326C20.1455 9.60944 19.8649 9.43733 19.5582 9.32787C19.2931 9.23187 19.0191 9.1622 18.7402 9.11987C18.5291 9.08729 18.3159 9.06991 18.1022 9.06787M17.7242 13.6559H17.5462V10.6959H17.9322C18.1026 10.6836 18.2735 10.7097 18.4324 10.7724C18.5913 10.8351 18.7341 10.9326 18.8502 11.0579C19.0909 11.3799 19.2194 11.7719 19.2162 12.1739C19.2162 12.6659 19.2162 13.1119 18.7722 13.4259C18.4524 13.6018 18.0883 13.683 17.7242 13.6559Z"
							fill="#464648"
						/>
						<path
							d="M25.0664 9.04188C24.8444 9.04188 24.6284 9.05788 24.4764 9.06388L24.0004 9.07588H22.4404V18.6759H24.2764C24.9781 18.6951 25.6767 18.5762 26.3324 18.3259C26.8603 18.1165 27.3276 17.779 27.6924 17.3439C28.0472 16.9048 28.3017 16.3936 28.4384 15.8459C28.5956 15.2256 28.6722 14.5877 28.6664 13.9479C28.7052 13.1922 28.6467 12.4347 28.4924 11.6939C28.346 11.1486 28.0718 10.6461 27.6924 10.2279C27.3948 9.89021 27.0305 9.61782 26.6224 9.42788C26.272 9.26571 25.9034 9.14619 25.5244 9.07188C25.3737 9.04699 25.2211 9.03561 25.0684 9.03788M24.7044 16.9119H24.5044V10.7839H24.5304C24.9427 10.7364 25.3599 10.8108 25.7304 10.9979C26.0018 11.2145 26.2228 11.4875 26.3784 11.7979C26.5463 12.1246 26.6431 12.4831 26.6624 12.8499C26.6804 13.2899 26.6624 13.6499 26.6624 13.9479C26.6706 14.2912 26.6485 14.6345 26.5964 14.9739C26.5348 15.3223 26.4208 15.6595 26.2584 15.9739C26.0746 16.2662 25.8263 16.5125 25.5324 16.6939C25.2857 16.8535 24.9935 16.9279 24.7004 16.9059"
							fill="#464648"
						/>
						<path
							d="M34.86 9.07617H30V18.6762H32.056V14.8682H34.656V13.0842H32.056V10.8602H34.856V9.07617"
							fill="#464648"
						/>
						<path
							d="M43.5624 40.51C43.5624 40.51 49.9384 39.354 49.9384 41.532C49.9384 43.71 45.9884 42.824 43.5624 40.51ZM38.8484 40.676C37.8353 40.8999 36.8481 41.2276 35.9024 41.654L36.7024 39.854C37.5024 38.054 38.3324 35.6 38.3324 35.6C39.287 37.2067 40.3977 38.7153 41.6484 40.104C40.7052 40.2447 39.7705 40.4369 38.8484 40.68V40.676ZM36.3244 27.676C36.3244 25.778 36.9384 25.26 37.4164 25.26C37.8944 25.26 38.4324 25.49 38.4504 27.138C38.2946 28.7951 37.9477 30.4287 37.4164 32.006C36.6886 30.6817 36.312 29.1931 36.3224 27.682L36.3244 27.676ZM27.0264 48.708C25.0704 47.538 31.1284 43.936 32.2264 43.82C32.2204 43.822 29.0744 49.932 27.0264 48.708ZM51.8004 41.79C51.7804 41.59 51.6004 39.376 47.6604 39.47C46.0181 39.4436 44.3766 39.5593 42.7544 39.816C41.1829 38.2328 39.8296 36.4471 38.7304 34.506C39.4229 32.5049 39.842 30.4194 39.9764 28.306C39.9184 25.906 39.3444 24.53 37.5044 24.55C35.6644 24.57 35.3964 26.18 35.6384 28.576C35.8754 30.1861 36.3226 31.7582 36.9684 33.252C36.9684 33.252 36.1184 35.898 34.9944 38.53C33.8704 41.162 33.1024 42.542 33.1024 42.542C31.1478 43.1783 29.3078 44.1236 27.6524 45.342C26.0044 46.876 25.3344 48.054 26.2024 49.232C26.9504 50.248 29.5684 50.478 31.9084 47.412C33.1517 45.8284 34.2875 44.1634 35.3084 42.428C35.3084 42.428 38.8764 41.45 39.9864 41.182C41.0964 40.914 42.4384 40.702 42.4384 40.702C42.4384 40.702 45.6964 43.98 48.8384 43.864C51.9804 43.748 51.8284 41.986 51.8084 41.794"
							fill="#DD2025"
						/>
						<path d="M47.9082 4.15381V15.8998H59.1742L47.9082 4.15381Z" fill="#909090" />
						<path d="M48.0625 4V15.746H59.3285L48.0625 4Z" fill="#F4F4F4" />
						<path
							d="M17.9499 8.91406H17.8899H17.4759H15.3359V18.5141H17.3999V15.2781L17.8559 15.3041C18.2971 15.2965 18.7341 15.2174 19.1499 15.0701C19.5145 14.9446 19.8499 14.7466 20.1359 14.4881C20.4248 14.241 20.6521 13.9302 20.7999 13.5801C21.0005 12.9971 21.0722 12.3775 21.0099 11.7641C20.9974 11.3259 20.9206 10.8919 20.7819 10.4761C20.6557 10.1759 20.4683 9.90526 20.2318 9.68145C19.9952 9.45763 19.7146 9.28552 19.4079 9.17606C19.1415 9.07912 18.8662 9.00878 18.5859 8.96606C18.3748 8.93348 18.1616 8.91611 17.9479 8.91406M17.5699 13.5021H17.3919V10.5421H17.7799C17.9503 10.5298 18.1212 10.5559 18.2801 10.6186C18.439 10.6812 18.5818 10.7788 18.6979 10.9041C18.9386 11.2261 19.0671 11.6181 19.0639 12.0201C19.0639 12.5121 19.0639 12.9581 18.6199 13.2721C18.3001 13.448 17.936 13.5272 17.5719 13.5001"
							fill="white"
						/>
						<path
							d="M24.912 8.88807C24.69 8.88807 24.474 8.90407 24.322 8.91007L23.852 8.92207H22.292V18.5221H24.128C24.8296 18.5413 25.5282 18.4224 26.184 18.1721C26.7118 17.9627 27.1792 17.6252 27.544 17.1901C27.8987 16.751 28.1533 16.2397 28.29 15.6921C28.4471 15.0718 28.5237 14.4339 28.518 13.7941C28.5568 13.0384 28.4983 12.2808 28.344 11.5401C28.1976 10.9948 27.9233 10.4923 27.544 10.0741C27.2464 9.7364 26.8821 9.46401 26.474 9.27407C26.1236 9.11191 25.7549 8.99238 25.376 8.91807C25.2253 8.89318 25.0727 8.8818 24.92 8.88407M24.556 16.7581H24.356V10.6301H24.382C24.7943 10.5826 25.2115 10.657 25.582 10.8441C25.8533 11.0607 26.0744 11.3337 26.23 11.6441C26.3979 11.9707 26.4947 12.3293 26.514 12.6961C26.532 13.1361 26.514 13.4961 26.514 13.7941C26.5221 14.1373 26.5001 14.4807 26.448 14.8201C26.3863 15.1685 26.2724 15.5057 26.11 15.8201C25.9262 16.1124 25.6778 16.3587 25.384 16.5401C25.1372 16.6997 24.845 16.7741 24.552 16.7521"
							fill="white"
						/>
						<path
							d="M34.7067 8.92188H29.8467V18.5219H31.9027V14.7139H34.5027V12.9299H31.9027V10.7059H34.7027V8.92188"
							fill="white"
						/>
					</svg>

					{image.fileName}
				</div>
			{:else}
				<img
					src={image.imgSource == ImgSourceEnum.remote
						? `${import.meta.env.VITE_PUBLIC_SUPABASE_STORAGE_URL}/${image.imgurl}`
						: image.imgurl}
					alt=""
					class="rounded-lg object-cover h-full w-full"
				/>
			{/if}
		</div>
	{/each}
</div>
